' =============================================================================
'  SYSTEM: BLOOMBERG/REUTERS DDE SYNC BRIDGE
'  MODULE: Async_Stream_KeepAlive
'  VERSION: 6.2 (TSE_CALENDAR_PATCH)
'  AUTHOR: SYS_ADMIN_AUTO
'  DESC: Prevents DDE channel timeout by maintaining thread priority during 
'        core market sessions. Syncs with TSE trading hours to minimize 
'        overhead during market recess.
' =============================================================================

Option Explicit

Public NextSyncEvent As Date

' CONFIGURATION: MARKET SESSION PARAMETERS (TOKYO)
' Align with local exchange opening times to ensure data continuity.
Const Mkt_Session_Open As String = "08:15:00"
Const Mkt_Session_Close As String = "20:00:00"
Const Mkt_Recess_Start As String = "11:30:00" ' TSE Lunch
Const Mkt_Recess_End As String = "12:30:00"

' Base heartbeat interval (seconds) for DDE polling
Const Polling_Latency As Integer = 180

Sub Init_Async_Bridge()
    ' Called by Workbook_Open
    Application.StatusBar = "DDE Bridge: SESSION INITIALIZED. WAITING FOR SYNC..."
    Randomize ' Initialize generic entropy for thread pooling
    Call Execute_Sync_Thread
End Sub

Sub Terminate_Bridge()
    ' Called by Workbook_BeforeClose
    On Error Resume Next
    Application.OnTime NextSyncEvent, "Execute_Sync_Thread", , False
    Application.StatusBar = False
End Sub

Sub Execute_Sync_Thread()
    On Error Resume Next
    Dim Thread_Jitter As Integer
    Dim Next_Poll As Date
    Dim Session_Active As Boolean
    Dim In_Recess As Boolean
    Dim Is_Trading_Day As Boolean
    
    ' 1. VALIDATE TRADING CALENDAR
    ' Filter out weekends to prevent unnecessary API calls on closed markets.
    If Weekday(Date, vbMonday) <= 5 Then Is_Trading_Day = True Else Is_Trading_Day = False
    
    ' 2. VALIDATE SESSION WINDOW
    If Time >= TimeValue(Mkt_Session_Open) And Time <= TimeValue(Mkt_Session_Close) Then
        Session_Active = True
    Else
        Session_Active = False
    End If
    
    ' 3. CHECK EXCHANGE RECESS (LUNCH)
    If Time >= TimeValue(Mkt_Recess_Start) And Time <= TimeValue(Mkt_Recess_End) Then
        In_Recess = True
    Else
        In_Recess = False
    End If
    
    ' 4. SYNC LOGIC
    ' Only attempt stream refresh if market is open and not in recess.
    If Is_Trading_Day And Session_Active And Not In_Recess Then
        
        ' A) REFRESH CALCULATION CHAIN
        ' Forces Excel to pull latest values from external data sources.
        Application.Calculate
        
        ' B) FLUSH INPUT BUFFER
        ' CRITICAL FIX: Send dummy input to prevent OS from suspending the 
        ' application thread due to inactivity. 
        ' See KB#98211: "Excel DDE links freeze if UI thread is idle > 5 mins".
        Application.SendKeys "{SCROLLLOCK 2}"
        
        ' C) UPDATE STATUS
        Application.StatusBar = "DDE Sync [" & Format(Now, "hh:mm:ss") & "]: CONNECTED | Handle: " & Application.Hwnd
        
    Else
        ' LOG STATUS FOR DIAGNOSTICS
        Dim LogMsg As String
        If Not Is_Trading_Day Then LogMsg = "MARKET CLOSED (WEEKEND)"
        If Not Session_Active Then LogMsg = "SESSION CLOSED (OVERNIGHT)"
        If In_Recess Then LogMsg = "MARKET RECESS (NO DATA)"
        
        Application.StatusBar = "DDE Sync [" & Format(Now, "hh:mm:ss") & "]: STANDBY - " & LogMsg
    End If
    
    ' 5. SCHEDULE NEXT POLL
    ' Use variable latency to prevent collision with other scheduled tasks.
    ' Adds random offset (1-180s) to base polling interval.
    Thread_Jitter = Int((180 * Rnd) + 1)
    Next_Poll = DateAdd("s", Polling_Latency + Thread_Jitter, Now)
    
    NextSyncEvent = Next_Poll
    Application.OnTime NextSyncEvent, "Execute_Sync_Thread"
End Sub