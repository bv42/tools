' =============================================================================
'  CORE: Async_Binding_Ref.v.4.5 (STOCHASTIC PATCH)
'  MODULE: Volatile_Calc_Engine
'  DESC: Heuristic refresh of calculation chain.
'        Uses variable latency to prevent thread locking on shared workbooks.
' =============================================================================

Public NextCycle As Date

' Base interval: 3 minutes. Jitter will add random minutes on top.
Const BaseLatency As Integer = 180 

Sub Init_Volatile_Binding()
    ' Button: "Enable Async Calc"
    Application.StatusBar = "Calculation Engine: BINDING ESTABLISHED..."
    Randomize ' Seed the random number generator
    Call Exec_Update_Cycle
End Sub

Sub Terminate_Binding()
    ' Button: "Release"
    On Error Resume Next
    Application.OnTime NextCycle, "Exec_Update_Cycle", , False
    Application.StatusBar = False
End Sub

Sub Exec_Update_Cycle()
    On Error Resume Next
    Dim Jitter As Integer
    Dim WaitTime As Date
    
    ' 1. FORCE CALCULATION (The Cover)
    Application.Calculate
    
    ' 2. INPUT INJECTION (The Keep-Alive)
    ' Fixes Known Issue #492: UI Thread suspension.
    Application.SendKeys "{SCROLLLOCK 2}"
    
    ' 3. CALCULATE RANDOM INTERVAL (The Anti-Pattern)
    ' Generates a random delay between 0 and 180 seconds (0-3 mins)
    ' Total wait will be 3 mins + random (3 to 6 mins total)
    Jitter = Int((180 * Rnd) + 1)
    
    WaitTime = DateAdd("s", BaseLatency + Jitter, Now)
    
    ' 4. TELEMETRY LOG
    Application.StatusBar = "Async Cycle OK | Next Refresh: " & Format(WaitTime, "hh:mm:ss") & " | Variance: " & Jitter & "ms"
    
    ' 5. SCHEDULE NEXT RUN
    NextCycle = WaitTime
    Application.OnTime NextCycle, "Exec_Update_Cycle"
End Sub